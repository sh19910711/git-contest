#!/usr/bin/env ruby

$:.unshift File.expand_path('../../lib', __FILE__)
require 'git/contest/common'
require 'trollop'

def use_current_branch
  current_branch = git_current_branch
  puts "current_branch = #{current_branch}"
  if current_branch.start_with? $PREFIX
    $BRANCH = current_branch.strip
    $NAME = $BRANCH[$PREFIX.length+1..-1]
  else
    puts "The current HEAD is no feature branch."
    puts "Please spefcify a <name> argument."
    abort ''
  end
end

def expand_contest_branch
  if ARGV.length == 0
    use_current_branch
  else
    $NAME = ARGV[0]
    $BRANCH = "#{$PREFIX}/#{$NAME}"
    require_branch $BRANCH
  end
end

def helper_finish_cleanup
  require_branch $BRANCH
  require_clean_working_tree

  if ! $options[:keep]
    git_do "branch -d #{$BRANCH}"
  end

  puts ""
  puts "Summary of actions:"
  puts "- The contest branch \"#{$BRANCH}\" was merged into \"#{$MASTER}\""
  puts "- Contest branch \"#{$BRANCH}\" has been removed"
  puts "- You are now on branch \"#{$MASTER}\""
  puts ""
end

init

sub_commands = %w()
$options = Trollop::options do
  version "git-contest #{Git::Contest::VERSION} (c) 2013 Hiroyuki Sano"
  opt(
    "no-edit",
    "Use default commit message.",
    :type => :flag,
    :default => false,
    :required => false,
  )
  opt(
    :keep,
    "Keep contest branch after merge.",
    :type => :flag,
    :default => false,
    :required => false,
  )
  stop_on sub_commands
end

expand_contest_branch()
require_branch $BRANCH

require_clean_working_tree

merge_options = ""
if $options["no-edit"]
  merge_options += " --no-edit"
end
git_do "checkout #{$MASTER}"
if git_do("rev-list -n2 \"#{$MASTER}..#{$BRANCH}\"").lines.length == 1
  git_do "merge --ff \"#{$BRANCH}\" #{merge_options}"
else
  git_do "merge --no-ff \"#{$BRANCH}\" #{merge_options}"
end

helper_finish_cleanup

